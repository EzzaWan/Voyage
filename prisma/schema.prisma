generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String        @id @default(uuid())
  email     String        @unique
  name      String?
  orders    Order[]
  profiles  EsimProfile[] @relation("UserProfiles")
  topups    TopUp[]
  affiliate Affiliate?
  referral  Referral?
  createdAt DateTime      @default(now())
}

model Plan {
  id           String   @id
  providerId   String
  locationCode String
  name         String
  dataBytes    BigInt
  validityDays Int
  priceCents   Int
  currency     String
  externalSlug String
  createdAt    DateTime @default(now())
}

model Order {
  id               String        @id @default(uuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id])
  planId           String
  amountCents      Int
  currency         String        // Always "usd" - stored internally in USD
  displayCurrency  String?       // Currency user actually paid in (e.g., "PLN", "EUR")
  displayAmountCents Int?        // Amount actually paid in display currency (cents)
  status           String        // pending, paid, provisioning, active, failed, cancelled
  paymentMethod    String
  paymentRef       String?
  esimOrderNo      String?       // eSIM Access orderNo
  receiptSent      Boolean       @default(false)
  profiles         EsimProfile[]
  createdAt        DateTime      @default(now())
}

model EsimProfile {
  id           String             @id @default(uuid())
  orderId      String
  order        Order              @relation(fields: [orderId], references: [id])
  esimTranNo   String
  iccid        String
  qrCodeUrl    String?
  ac           String?            // activation code
  smdpStatus   String?
  esimStatus   String?
  totalVolume  BigInt?
  orderUsage   BigInt?
  expiredTime  DateTime?
  userId       String?            // Optional initially, but linked to User for direct access
  user         User?              @relation("UserProfiles", fields: [userId], references: [id])
  topups       TopUp[]
  usageHistory EsimUsageHistory[]
}

model TopUp {
  id               String      @id @default(uuid())
  userId           String
  user             User        @relation(fields: [userId], references: [id])
  profileId        String
  profile          EsimProfile @relation(fields: [profileId], references: [id])
  planCode         String
  amountCents      Int
  currency         String      // Always "usd" - stored internally in USD
  displayCurrency  String?     // Currency user actually paid in (e.g., "PLN", "EUR")
  displayAmountCents Int?      // Amount actually paid in display currency (cents)
  status           String      // pending, processing, completed, failed
  paymentRef       String?
  rechargeOrder    String?     // provider recharge orderNo
  createdAt        DateTime    @default(now())
}

model WebhookEvent {
  id        String   @id @default(uuid())
  source    String
  payload   Json
  processed Boolean  @default(false)
  createdAt DateTime @default(now())
}

model AdminLog {
  id         String   @id @default(uuid())
  action     String
  adminEmail String
  entityType String
  entityId   String
  data       Json
  createdAt  DateTime @default(now())
}

model AdminSettings {
  id                  String   @id @default("settings")
  mockMode            Boolean  @default(false)
  defaultMarkupPercent Float    @default(0)
  defaultCurrency     String   @default("USD")
  adminEmails         String[]
  emailFrom           String?
  emailProvider       String?
  emailEnabled        Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model EmailLog {
  id         String   @id @default(uuid())
  to         String
  from       String
  subject    String
  template   String
  variables  Json?
  providerId String?
  status     String   // sent, failed, mock, pending
  error      String?
  createdAt  DateTime @default(now())
}

model EsimUsageHistory {
  id        String      @id @default(uuid())
  profileId String
  profile   EsimProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  usedBytes BigInt      // how much used at this timestamp
  recordedAt DateTime   @default(now())

  @@index([profileId])
  @@index([profileId, recordedAt])
}

model Affiliate {
  id              String       @id @default(uuid())
  userId          String       @unique
  user            User         @relation(fields: [userId], references: [id])
  referralCode    String       @unique
  totalCommission Int          @default(0)
  createdAt       DateTime     @default(now())
  referrals       Referral[]
  commissions     Commission[]

  @@index([referralCode])
}

model Referral {
  id             String     @id @default(uuid())
  affiliateId    String
  affiliate      Affiliate  @relation(fields: [affiliateId], references: [id])
  referredUserId String     @unique
  user           User       @relation(fields: [referredUserId], references: [id])
  createdAt      DateTime   @default(now())

  @@index([affiliateId])
  @@index([referredUserId])
}

model Commission {
  id          String     @id @default(uuid())
  affiliateId String
  affiliate   Affiliate  @relation(fields: [affiliateId], references: [id])
  orderId     String?    // Can be Order or TopUp ID
  orderType   String     // "order" or "topup"
  amountCents Int
  createdAt   DateTime   @default(now())

  @@index([affiliateId])
  @@index([orderId])
}

model ErrorLog {
  id        String   @id @default(uuid())
  message   String
  stack     String?
  route     String
  userId    String?
  status    Int?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([route])
}
